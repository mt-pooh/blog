---
title: "Snowflake CLIã‚’åˆ©ç”¨ã—ãŸStreamlit in Snowflakeã‚¢ãƒ—ãƒªã®é–‹ç™ºã€GitHub Actionsã‚’ç”¨ã„ãŸCICD"
emoji: "â„ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["snowflake", "streamlit", "githubactions", "cicd"]
published: true
---

## ã¯ã˜ã‚ã«
Streamlit in Snowflake(ä»¥ä¸‹ SiS)ã¯ã€Snowflake ä¸Šã§ Streamlit ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ãªã©ãªãã€æ°—è»½ã« Streamlit ã‚¢ãƒ—ãƒªã‚’ Snowflake ä¸Šã§å®Ÿè¡Œã§ãã‚‹ãŸã‚ã€éå¸¸ã«ä¾¿åˆ©ãªæ©Ÿèƒ½ã§ã™ã€‚
ãŸã ã€ç¾åœ¨ã§ã¯ Git çµ±åˆã€CI/CD ã®ã‚µãƒãƒ¼ãƒˆãŒä¸ååˆ†[^1]ã§ã€ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒç…©é›‘ã§ã—ãŸã€‚å®Ÿéš›ç§ã¯[Snowpark API](https://docs.snowflake.com/en/developer-guide/snowpark/index)ã‚’åˆ©ç”¨ã—ã¦ã€stage ã« upload ã™ã‚‹ Python ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ã‚¹ã‚¿ãƒ ã§æ›¸ã„ã¦ã¾ã—ãŸã€‚

ä¸€æ–¹ã€[Snowflake CLI](https://docs.snowflake.com/en/developer-guide/snowflake-cli-v2/index) ãŒ Public Preview ã«ãªã‚Šã€CLI ã§ Snowflake ä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œæˆã€ç®¡ç†ã€æ›´æ–°ã€è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã“ã® Snowflake CLI ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€SiS ã‚¢ãƒ—ãƒªã‚’ç°¡å˜ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã“ã¡ã‚‰ã®è¨˜äº‹ã§ã¯ã€Snowflake CLI ã‚’åˆ©ç”¨ã—ã¦ SiS ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã€ã¾ãŸã€GitHub Actions ã‚’ç”¨ã„ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
.
â”œâ”€â”€ README.md
â”œâ”€â”€ Makefile
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ poetry.lock
â”œâ”€â”€ apps
â”‚   â”œâ”€â”€ example_streamlit
â”‚   â”‚   â”œâ”€â”€ .snowflake
â”‚   â”‚   â”‚   â”œâ”€â”€ config_ci.json
â”‚   â”‚   â”‚   â””â”€â”€ config.json
â”‚   â”‚   â”œâ”€â”€ common
â”‚   â”‚   â”‚   â””â”€â”€ hello.py
â”‚   â”‚   â”œâ”€â”€ environment.yml
â”‚   â”‚   â”œâ”€â”€ snowflake.yml
â”‚   â”‚   â””â”€â”€ streamlit_app.py
â”‚   â””â”€â”€ app2
â””â”€â”€ .github
    â””â”€â”€ workflows
        â”œâ”€â”€ CI.yml
        â”œâ”€â”€ CD_example_streamlit.yml
        â””â”€â”€ CD_workflow_base.yml
```
ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã€`apps`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« SiS ã‚¢ãƒ—ãƒªã‚’æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚`example_streamlit`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€SiS ã‚¢ãƒ—ãƒªã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„ Streamlit ã‚¢ãƒ—ãƒªã®ã‚³ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚`app2`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€åˆ¥ã® SiS ã‚¢ãƒ—ãƒªãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã® Streamlit ã®ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
```python:apps/example_streamlit/streamlit_app.py
import streamlit as st
from common.hello import say_hello

st.title(f"Example streamlit app. {say_hello()}")
```

```python:apps/example_streamlit/common/hello.py
def say_hello():
    return "Hello, World!"
```

## SiSã‚¢ãƒ—ãƒªã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
SiS ã‚¢ãƒ—ãƒªã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€`snowflake.yml`ã¨ `environment.yml` ã® 2 ã¤ã§ã™ã€‚`snowflake.yml`ã¯ã€SiS ã‚¢ãƒ—ãƒªã®è¨­å®šã‚’è¨˜è¿°ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€`environment.yml`ã¯ã€SiS ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¨˜è¿°ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

```yaml:snowflake.yml
definition_version: 1
streamlit:
  name: example_streamlit
  stage: STAGE_NAME
  query_warehouse: WAREHOUSE_NAME
  main_file: streamlit_app.py
  env_file: environment.yml
  additional_source_files:
    - common/hello.py
  # ä»Šå›ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªãªã®ã§ã€ä»¥ä¸‹ã®è¨­å®šã¯ä¸è¦
  # pages_dir: pages/
```

```yaml:environment.yml
name: sf_env
channels:
  - snowflake
dependencies:
  - pandas # ã“ã“ã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¨˜è¿°
```

## Snowflakeèªè¨¼æƒ…å ±ã®è¨­å®š
Snowflake CLI ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€Snowflake èªè¨¼æƒ…å ±ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚èªè¨¼æƒ…å ±ã¯ã€`config.toml`ã¨ `config_ci.toml` ã® 2 ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ã¾ã™ã€‚

```toml:config.toml
default_connection_name = "snowflake"
[connections]
[connections.snowflake]
account = "ACCOUNT_NAME"
user = "USER_NAME"
role = "ROLE_NAME"
database = "DATABASE_NAME"
schema = "SCHEMA_NAME"
warehouse = "WAREHOUSE_NAME"
authenticator = "SNOWFLAKE_JWT"
private_key_path = "path/to/private_key"
```

:::message alert
config.toml ã«ã¯ã€ç§˜å¯†æƒ…å ±ã‚’å«ã‚€ãŸã‚ã€ãƒªãƒã‚¸ãƒˆãƒªã«ã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚
é–‹ç™ºè€…ã® local ç’°å¢ƒã ã‘ã«ã€config.toml ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
:::

ä»¥ä¸‹ã¯ CI/CD ç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹ã§ã™ã€‚

```toml:config_ci.toml
default_connection_name = "snowflake"
[connections]
[connections.snowflake]
account = "ACCOUNT_NAME"
role = "ROLE_NAME"
database = "DATABASE_NAME"
schema = "SCHEMA_NAME"
warehouse = "WAREHOUSE_NAME"
```

## local Pythonç’°å¢ƒã®è¨­å®š
local ã§ SiS ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€Python ç’°å¢ƒã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€[Poetry](https://python-poetry.org/)ã‚’åˆ©ç”¨ã—ã¦ Python ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

```bash
poetry add snowflake-connector-python==${SNOWFLAKE_CONNECTOR_PYTHON} streamlit==${STREAMLIT_VERSION}
poetry add --group dev black isort flake8 mypy snowflake-cli-labs
```

ã¤ã„ã§ã«ã€`Makefile`ã®è¨­å®šã‚’ã—ã¾ã™ã€‚

```Makefile
init:
	poetry install
	poetry run pre-commit install
	
new_streamlit_app: __require_streamlit_app_name__
	cp -r apps/example_streamlit apps/${STREAMLIT_APP_NAME}
	cd apps/${STREAMLIT_APP_NAME}

format:
	poetry run isort apps/
	poetry run black apps/

lint:
	poetry run flake8 apps/
	poetry run black --check apps/
	poetry run isort --check-only apps/
	poetry run mypy apps/

run_streamlit: __require_streamlit_app_name__
	cd apps/${STREAMLIT_APP_NAME} && \
		poetry run streamlit run streamlit_app.py

deploy_streamlit: __require_streamlit_app_name__
	cd apps/${STREAMLIT_APP_NAME} && \
		poetry run snow --config-file .snowflake/config.toml \
			streamlit deploy --replace

deploy_streamlit_ci: __require_streamlit_app_name__
	cd apps/${STREAMLIT_APP_NAME} && \
		poetry run snow --config-file .snowflake/config_ci.toml \
			streamlit deploy --replace

__require_streamlit_app_name__:
	@[ -n "$(STREAMLIT_APP_NAME)" ] || (echo "[ERROR] Parameter [STREAMLIT_APP_NAME] is requierd" 1>&2 && echo "(e.g) make xxx STREAMLIT_APP_NAME=hoge" 1>&2 && exit 1)
```
ã“ã‚Œã§
- `make init`ã§ Python ç’°å¢ƒã‚’æ§‹ç¯‰
- `make new_streamlit_app STREAMLIT_APP_NAME=example_streamlit`ã§æ–°ã—ã„ SiS ã‚¢ãƒ—ãƒªã‚’ä½œæˆ
- `make format`ã§ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- `make lint`ã§ã‚³ãƒ¼ãƒ‰ã® Lint
- `make run_streamlit STREAMLIT_APP_NAME=example_streamlit`ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ SiS ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œ
- `make deploy_streamlit STREAMLIT_APP_NAME=example_streamlit`ã§ SiS ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚


## GitHub Actionsã‚’åˆ©ç”¨ã—ãŸCI/CD
GitHub Actions ã‚’åˆ©ç”¨ã—ã¦ã€SiS ã‚¢ãƒ—ãƒªã® CI/CD ã‚’è¡Œã„ã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€CI ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã“ã¡ã‚‰ã§ GitHub ä¸Šã§ PR ãŒä½œæˆã•ã‚ŒãŸã¨ãã«ã€ã‹ã¤ã€`apps`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«ã€Lint ã‚’è¡Œã„ã¾ã™ã€‚
```yaml:.github/workflows/CI.yml
name: CI
on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "apps/**"
    branches:
      - master
jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Set up Python
        # This is the version of the action for setting up Python, not the Python version.
        uses: actions/setup-python@v5
        with:
          # Semantic version range syntax or exact version of a Python version
          python-version: '3.11'
      - name: Install poetry
        run: |
          curl -sSL https://install.python-poetry.org | python - --version 1.8.2
          echo "$HOME/.poetry/bin" >> $GITHUB_PATH
      - name: Poetry Version
        run: |
          poetry --version
      - name: Poetry Install Dependencies
        run: |
          poetry install
      - name: lint
        run: make lint
```


ä»¥ä¸‹ã¯ã€SiS ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã® GitHub Actions ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
```yaml:.github/workflows/CD_workflow_base.yml
name: Streamlit in Snowflake deploy base
on:
  workflow_call:
    inputs:
      streamlit_app_name:
        required: true
        type: string
    secrets:
      SNOWFLAKE_USER:
        required: true
        description: "Snowflake user name"
      SNOWFLAKE_PASSWORD:
        required: true
        description: "Snowflake password"
jobs:
  streamlit_deploy:
    name: SiS Deploy
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Set up Python
        # This is the version of the action for setting up Python, not the Python version.
        uses: actions/setup-python@v5
        with:
          # Semantic version range syntax or exact version of a Python version
          python-version: '3.11'
      - name: Install poetry
        run: |
          curl -sSL https://install.python-poetry.org | python - --version 1.8.2
          echo "$HOME/.poetry/bin" >> $GITHUB_PATH
      - name: Poetry Version
        run: |
          poetry --version
      - name: Poetry Install Dependencies
        run: |
          poetry install
      - name: lint
        run: make lint
      - name: deploy Sis App
        env:
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          make deploy_streamlit_ci STREAMLIT_APP_NAME=${{ inputs.streamlit_app_name }}
```

ä»¥ä¸‹ã¯ã€`example_streamlit`ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
```yaml:.github/workflows/CD_example_streamlit.yml
name: Deploy example_streamlit app
on:
  push:
    branches:
      - master
    paths:
      - 'apps/example_streamlit/**'
jobs:
  call_CD_workflow:
    uses: ./.github/workflows/CD_workflow_base.yml
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    with:
      streamlit_app_name: example_streamlit
    secrets:
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
```
:::message
`SNOWFLAKE_USER`ã¨ `SNOWFLAKE_PASSWORD` ã¯ã€GitHub ã® Secrets ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
ã“ã¡ã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Snowflake ä¸Šã§ SiS ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
å¿…è¦ãªæ¨©é™ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://docs.snowflake.com/ja/developer-guide/streamlit/about-streamlit#privileges-required-to-create-a-streamlit-app
:::

ã“ã‚Œã§ã€PR ãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸã¨ãã«ã€`example_streamlit`ã‚¢ãƒ—ãƒªãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ğŸ‰

![Snowflakeã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸStreamlitã‚¢ãƒ—ãƒª](https://storage.googleapis.com/zenn-user-upload/4452e8648176-20240520.png)

## ãŠã‚ã‚Šã«
Snowflake CLI ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€SiS ã‚¢ãƒ—ãƒªã®é–‹ç™ºã€ãƒ‡ãƒ—ãƒ­ã‚¤ãŒç°¡å˜ã«ãªã‚Šã¾ã—ãŸã€‚ã¾ãŸã€GitHub Actions ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€CI/CD ã‚‚ç°¡å˜ã«è¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚SiS ã‚¢ãƒ—ãƒªã‚’ãƒãƒ¼ãƒ ã§é–‹ç™ºã—ã¦ã„ãã€ãã—ã¦è¨­å®šã‚’å®‰å…¨ã«ç®¡ç†ã—ã¦ã„ãã®ã«ä¾¿åˆ©ãªã®ã§ãœã²ãŠè©¦ã—ãã ã•ã„ï¼


## å‚è€ƒæ–‡çŒ®
- [Managing Streamlit apps with Snowflake CLI | Snowflake Documentation](https://docs.snowflake.com/en/developer-guide/snowflake-cli-v2/streamlit-apps/overview)

[^1]: [åˆ¶é™ã¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„æ©Ÿèƒ½ | Snowflake Documentation](https://docs.snowflake.com/ja/developer-guide/streamlit/limitations#integrated-version-control-or-ci-cd-systems-are-not-supported)
