---
title: "GitHub Actionsã®ã¿ã§Atlantis likeãªTerraform CICDã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ› "
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Terraform", "GitHubActions", "CICD"]
published: false
---
:::message
ã“ã®è¨˜äº‹ã¯Finatextã‚°ãƒ«ãƒ¼ãƒ—10å‘¨å¹´è¨˜å¿µã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®7æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
æ˜¨æ—¥ã¯Toddã•ã‚“ãŒã€Œâ—â—â—â—ã€ã¨ã„ã†è¨˜äº‹ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚
:::

# ã¯ã˜ã‚ã«
Terraformã‚’å°å…¥ã—ã¦IaCåŒ–ã‚’ã—ãŸã®ã¡ã«ã€IaCã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä»•çµ„ã¿ã€å®‰å…¨ãªTerraform Applyã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

åŸ·ç­†ç¾åœ¨ã€ç§ãŒæ‰€å±ã—ã¦ã„ã‚‹Finatextã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒŠã‚¦ã‚­ãƒ£ã‚¹ãƒˆã§ã¯[Atlantis](https://www.runatlantis.io/)ã¨ã„ã†Terraformã®Planã‚„Applyã‚’Github Pull Requestä¸Šã§åˆ¶å¾¡ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ç”¨ã„ã¦ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰é©ç”¨ã¾ã§æ¥½ã«é‹ç”¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ref: [SnowflakeÃ—dbtÃ—Terraformã§ãƒ¢ãƒ€ãƒ³ãªãƒ‡ãƒ¼ã‚¿åŸºç›¤é–‹ç™ºã—ã¦ã¿ãŸ](https://techblog.finatext.com/snowflake-dbt-terraform-15615b020857)

ãŸã ã€Atlantisã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯è‡ªå‰ã§Atlantisã®ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãã®ãŸã‚ã«ã¯ã‚µãƒ¼ãƒãƒ¼ã®ç®¡ç†ã‚„é‹ç”¨ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ç¤¾å†…ã§ã®ãƒªã‚½ãƒ¼ã‚¹ã®ç¢ºä¿ã‚„é‹ç”¨ã®ãŸã‚ã®äººå“¡ã®ç¢ºä¿ãŒé›£ã—ã„å ´åˆã«ã¯ã€Atlantisã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’è«¦ã‚ã¦ã—ã¾ã†ã“ã¨ã‚‚ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
ä»Šå›ã¯ã‚ˆã‚Šã‚¹ãƒ¢ãƒ¼ãƒ«ã«GitHub Actionsã®ã¿ã§Atlantis likeãªTerraformã®CICDã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

# ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
ä»Šå›ã¯è¤‡æ•°ã®Google Cloud ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ã€Terraformã®CICDã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

ç®¡ç†ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
äºŒã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã™ã§ã«å­˜åœ¨ã—ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚

- project-a-dev
- project-b-prod

ãªãŠã€Terraformã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯projectã”ã¨ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ†ã‘ã€ãã®ä¸­ã«projectã”ã¨ã®Terraformã®ã‚³ãƒ¼ãƒ‰ã‚’é…ç½®ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã¨ã—ã¦ã¯ã€mainãƒ–ãƒ©ãƒ³ãƒã®ã¿ã®é‹ç”¨ã¨ã—ã¾ã™ã€‚
ex. project-a-devã®Terraformã‚³ãƒ¼ãƒ‰ã¯`environments/project-a-dev`ã«é…ç½®ã™ã‚‹ã€‚ãã®å†…å®¹ã‚’åæ˜ ã•ã›ãŸã„å ´åˆã€mainãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã—ã¦PRã‚’ä½œæˆã™ã‚‹ã€‚

```ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
root/environments  
â”œ project-a-dev
â”” project-b-prod
```

# Terraform Planã®å®Ÿè¡Œ
Terraform Planã¯PRãŒä½œæˆã•ã‚ŒãŸæ™‚(ã¨æ–°ãŸãªpushãŒç”Ÿã˜ãŸæ™‚)ã¨PRã®ã‚³ãƒ¡ãƒ³ãƒˆä¸Šã§`terraform plan [projectå]`ã¨å…¥åŠ›ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã¾ãŸã€Terraform Planã®å®Ÿè¡Œçµæœã¯PRã®ã‚³ãƒ¡ãƒ³ãƒˆä¸Šã«è¿½è¨˜ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
```yaml
jobs:
  terraform_plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: "environments/${{inputs.project}}/" # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ†ã‘ã¦ã„ã‚‹
    steps:
      - name: Checkout Repo
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v2

      - name: Checkout Repo
        if: github.event_name == 'issue_comment'
        uses: actions/checkout@v2
        with:
          ref: refs/pull/${{ github.event.issue.number }}/merge

      - name: Get PR Number
        id: get-pr-number
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "pr_number=${{ github.event.number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          create_credentials_file: true
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Plan
        id: plan
        if: steps.lock-check.outputs.locked == 'false'
        run: |
          echo "plan_output_path=$(pwd)/plan_output.txt" >> "$GITHUB_OUTPUT"
          terraform plan -no-color > plan_output.txt 2>&1

      - name: Comment Plan Result on PR
        if: always() && steps.lock-check.outputs.locked == 'false'
        uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ steps.plan.outputs.plan_output_path }}', 'utf8');
            const commentBody = `
            Ran Plan for dir: \`${{inputs.project}}\`
            <details>

            <summary>Show Output</summary>

            \`\`\`
            ${planOutput}
            \`\`\`

            </details>

            To apply this plan, comment: \`terraform apply ${{inputs.project}}\`
            To plan this project again, comment: \`terraform plan ${{inputs.project}}\`
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
```

# Terraform Applyã®å®Ÿè¡Œ
Terraform Applyã¯Approveã•ã‚ŒãŸPRã®ã‚³ãƒ¡ãƒ³ãƒˆä¸Šã§`terraform apply [projectå]`ã¨å…¥åŠ›ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
Terraform Planã¨åŒæ§˜ã«Terraform Applyã®å®Ÿè¡Œçµæœã¯PRã®ã‚³ãƒ¡ãƒ³ãƒˆä¸Šã«è¿½è¨˜ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
```yaml
jobs:
  terraform_apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: "environments/${{inputs.project}}/"
    steps:
      - name: Checkout Repo
        if: github.event_name == 'issue_comment'
        uses: actions/checkout@v2
        with:
          ref: refs/pull/${{ github.event.issue.number }}/merge

      - name: Check PR Approval Status
        id: check-pr-status
        uses: actions/github-script@v5
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
             });
            const RequestChanges = reviews.some(review => review.state === 'CHANGES_REQUESTED');
            const Approved = !RequestChanges && reviews.some(review => review.state === 'APPROVED');

            core.setOutput('approved', Approved);

      - name: Comment and exit if not approved
        if: steps.check-pr-status.outputs.approved == 'false'
        uses: actions/github-script@v5
        with:
          script: |
            await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'Failed: Pull request is not approved.'
            });

            process.exit(1);

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          create_credentials_file: true
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init -no-color

      - name: Terraform Apply
        id: apply
        if: steps.lock-check.outputs.locked == 'false' && steps.check-pr-status.outputs.approved == 'true'
        run: |
          echo "apply_output_path=$(pwd)/apply_output.txt" >> "$GITHUB_OUTPUT"
          terraform apply -auto-approve -no-color > apply_output.txt 2>&1

      - name: Comment Apply Result on PR
        if: always() && steps.lock-check.outputs.locked == 'false' && steps.check-pr-status.outputs.approved == 'true'
        uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs');
            const applyOutput = fs.readFileSync('${{ steps.apply.outputs.apply_output_path }}', 'utf8');
            const commentBody = `
            Ran Apply for dir: \`${{inputs.project}}\`
            <details>

            <summary>Show Output</summary>

            \`\`\`
            ${applyOutput}
            \`\`\`

            </details>
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
```


# Terraformã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹
ä»¥ä¸Šã§GitHub Actionsã®ã¿ã§Terraformã®CICDã®ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
ã—ã‹ã—ã€ä¸Šè¨˜ã®ã¾ã¾ã§ã‚ã‚Œã°è¤‡æ•°äººãŒåŒæ™‚ã«Terraform Apply, Planã‚’å®Ÿè¡Œã—ã¦ã—ã¾ã†ã¨ã€ç«¶åˆãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã€å±é™ºã§ã™ã€‚

ä¾‹ãˆã°ã‚ã‚‹äººãŒTerraform Planã‚’å®Ÿè¡Œã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã„ã‚‹æœ€ä¸­ã«ã€åˆ¥ã®äººãŒTerraform Applyã‚’å®Ÿè¡Œã—ã¦ã—ã¾ã†ã¨ã€Planã®å†…å®¹ã¨Applyã®å†…å®¹ã«é½Ÿé½¬ãŒç”Ÿã¾ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®ãŸã‚Terraformã®å®Ÿè¡Œã‚’åˆ¶é™ã™ã‚‹ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã®ä»•çµ„ã¿ãŒå¿…è¦ã§ã™ã€‚
ãƒãƒ¼ãƒ ã§æ´»ç™ºã«Terraformã‚’ç”¨ã„ã¦ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ç®¡ç†ã—ã¦ã„ãä¸Šã§ã¯Terraformã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã®æ§‹ç¯‰ã¯å¿…è¦ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã€Terraformå®Ÿè¡Œã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã§ä»¥ä¸‹ã®3ã¤ã®ä»•çµ„ã¿ã‚’æ¡ç”¨ãƒ»æ§‹ç¯‰ã—ã¾ã—ãŸã€‚
- Terraform state locking
- GitHub Actions jobã®åŒæ™‚å®Ÿè¡Œã®æ’ä»–åˆ¶å¾¡
- labelã‚’ä½¿ç”¨ã—ãŸPRã”ã¨ã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹

## Terraform state locking
ã“ã¡ã‚‰ã¯Terraformã®æ¨™æº–æ©Ÿèƒ½ã§ã€Terraformã®stateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€è¤‡æ•°äººãŒåŒæ™‚ã«Terraform Apply, Planã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚
state lockingæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€state lockingã«å¯¾å¿œã—ãŸbackendã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»Šå›ã®æ§‹æˆã§ã¯ã€Google Cloud Storage (GCS)ã‚’åˆ©ç”¨ã—ãŸbackendã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚GCSã¯state lockingã«å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ã€state lockingæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[Backend Type: gcs | Terraform | HashiCorp Developer](https://developer.hashicorp.com/terraform/language/settings/backends/gcs)

## GitHub Actions jobã®åŒæ™‚å®Ÿè¡Œã®æ’ä»–åˆ¶å¾¡
ã“ã¡ã‚‰ã¯GitHub Actionsã®æ¨™æº–æ©Ÿèƒ½ã§ã€åŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹jobã®æ•°ã‚’åˆ¶é™ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

[Using concurrency - GitHub Docs](https://docs.github.com/en/actions/using-jobs/using-concurrency)

ç°¡å˜ã«ã¾ã¨ã‚ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªæ©Ÿèƒ½ã§ã™ã€‚
- group
  - ã‚¿ã‚°ã®ã‚ˆã†ãªã‚‚ã®ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ãŸã‚ã®è­˜åˆ¥å­ã€‚
  - ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—åãŒã¤ã„ã¦ã„ã‚‹ã‚‚ã®ã¯ã€åŒæ™‚ã«å®Ÿè¡Œã•ã‚Œãªã„ã€‚

- cancel-in-progress(True or False)
  - True
    - åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã¨ã€é€²è¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹ã€‚
  - False
    - æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¾…æ©Ÿã—ã€æ—¢å­˜ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã™ã‚‹ã¾ã§å®Ÿè¡Œã•ã‚Œãªã„ã€‚
    - åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§CICDãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã¯ãªããªã‚‹ãŒã€jobã®æˆåŠŸã€å¤±æ•—ã«ã‹ã‹ã‚ã‚‰ãšãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒçµ‚äº†ã™ã‚‹ã¨å¾Œç¶šã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‹•ãå‡ºã™ã€‚

ä»Šå›ã¯
- åŒã˜projectã®plan, applyã‚’åŒä¸€groupã«è¨­å®š
  - project-a-dev
  - project-b-prod
- cancel-in-progressã‚’Falseã«è¨­å®š

ã¨ã—ã¾ã—ãŸã€‚
ã“ã®è¨­å®šã«ã‚ˆã‚Šã€åŒã˜projectã®plan, applyã¯åŒæ™‚ã«å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## labelã‚’ä½¿ç”¨ã—ãŸPRã”ã¨ã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹
ã“ã¡ã‚‰ã¯Atlantisã®Lockingæ©Ÿèƒ½ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚
ãã‚‚ãã‚‚ãªãœPRã”ã¨ã®lockæ©Ÿèƒ½ãŒå¿…è¦ã‹ã¯Atlantisã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

[Locking | Atlantis](https://www.runatlantis.io/docs/locking.html)

ä»Šå›Terraform Apllyã®å®Ÿè¡Œã¯mainãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã—ã¦PRãŒmergeã•ã‚ŒãŸæ™‚ã§ã¯ãªãã€PRãŒApproveã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
ã¨ãªã‚‹ã¨mainãƒ–ãƒ©ãƒ³ãƒã®Terraformã®ã‚³ãƒ¼ãƒ‰ã¨å®Ÿéš›ã®ã‚¤ãƒ³ãƒ•ãƒ©ã®çŠ¶æ…‹ãŒç•°ãªã£ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
å®Ÿéš›ã«ã“ã®çŠ¶æ…‹ãŒä¸å¥å…¨ã¨è€ƒãˆã€Terraform Applyã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯PRãŒmergeã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹æ–¹ã‚‚ã„ã‚‰ã£ã—ã‚ƒã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
ã—ã‹ã—ã€Terraform Applyã¯å¤±æ•—ã™ã‚‹ã“ã¨ãŒåº¦ã€…ã‚ã‚Š(Terraform planã‚„validateã¯OKã§ã‚‚)ã€ãã®æ¤œçŸ¥ã¯PRãŒmergeã•ã‚ŒãŸå¾Œã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã¨ãªã‚‹ã¨durtyãªTerraformã®ã‚³ãƒ¼ãƒ‰ãŒmainãƒ–ãƒ©ãƒ³ãƒã«å­˜åœ¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€ã¾ãŸä¿®æ­£ã®PRã‚’è¿½åŠ ã§ç”¨æ„ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚
ãªã®ã§ã€Terraform Applyã¯PRãŒmergeã•ã‚Œã‚‹å‰ã«PRã®ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã¿ã¨ã—ã¾ã—ãŸã€‚

ãŸã ã€ä½•ã®åˆ¶é™ã‚‚ãªãPRã§Terraform Applyã‚’å®Ÿè¡Œã§ãã¦ã—ã¾ã†ã¨å±é™ºãªã®ã§Approveã•ã‚ŒãŸPRã§ã®ã¿Terraform Applyã‚’å®Ÿè¡Œã§ããªã„åˆ¶é™ã¨è¿½åŠ ã§ã€PRã”ã¨ã«labelã‚’ç”¨ã„ãŸTerraformã®lockæ©Ÿèƒ½ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚

ä»¥ä¸‹ãŒlabelã‚’ç”¨ã„ãŸPRã”ã¨ã®lockæ©Ÿèƒ½ã®ä»•çµ„ã¿ã§ã™ã€‚
- Terraform PlanãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ãã®PRã«å¯¾ã—ã¦`terraform_lock`ã¨ã„ã†ãƒ©ãƒ™ãƒ«ãŒä»˜ä¸ã•ã‚Œã‚‹
- ã‚‚ã—é•ã†PRã§terraform plan or terraform applyãŒå®Ÿè¡Œã•ã‚Œã‚ˆã†ã¨ã—ãŸã‚‰ä»–ã®openãªPRã«å¯¾ã—ã¦`terraform_lock`ãƒ©ãƒ™ãƒ«ãŒã¤ã„ã¦ãªã„ã‹ç¢ºèªã™ã‚‹ã€‚ä»˜ã„ã¦ã„ãŸã‚‰cancelã€ä»˜ã„ã¦ãªã‹ã£ãŸã‚‰å®Ÿè¡Œã€`terraform_lock`ã®ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
- `terraform_apply`ãƒ©ãƒ™ãƒ«ãŒã¤ã„ãŸPRãªã‚‰terraform applyã¯å®Ÿè¡Œã§ãã‚‹ã€mainãƒ–ãƒ©ãƒ³ãƒã«mergeã•ã‚ŒãŸã‚‰`terraform_lock`ãƒ©ãƒ™ãƒ«ã¯é™¤å»ã•ã‚Œã‚‹
- ã‚‚ã—ã‚ã‚‹PRã‹ã‚‰`terraform_lock`ãƒ©ãƒ™ãƒ«ã‚’é™¤å»ã—ãŸã‹ã£ãŸã‚‰PRã®ã‚³ãƒ¡ãƒ³ãƒˆã§`terraform unlock`ã¨å…¥åŠ›ã—ãŸã‚‰é™¤å»ã•ã‚Œã‚‹

```mermaid
graph TD;

subgraph "æ–°ã—ã„PRã§ã®terraformå®Ÿè¡Œ"
  C{{æ–°ã—ã„PRã§terraformå®Ÿè¡Œ}} -->D[ä»–ã®open PRã«`terraform_lock`ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèª]
  D -->E{`terraform_lock`ãƒ©ãƒ™ãƒ«}
  E --> |å­˜åœ¨ã—ãªã„|PRã«å®Ÿè¡Œä¸å¯ã§ã‚ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»˜ä¸
	E --> |å­˜åœ¨ã™ã‚‹|F[terraformå®Ÿè¡Œ]
	F --> `terraform_lock`ãƒ©ãƒ™ãƒ«ä»˜ä¸
end

subgraph "ãƒ©ãƒ™ãƒ«é™¤å»"
  I[PRãƒãƒ¼ã‚¸] --> K
  J[PRã‚³ãƒ¡ãƒ³ãƒˆã§terraform unlock]
  J -->K[`terraform_lock`ãƒ©ãƒ™ãƒ«é™¤å»]
end
```

ä»¥ä¸‹ã¯å®Ÿéš›ã®å®Ÿè£…ã§ã™ã€‚(planã‚‚applyã‚‚åŒã˜ã‚ˆã†ãªå®Ÿè£…ã§ã™)
```yaml
jobs:
  terraform_plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: "environments/${{inputs.project}}/"
    steps:
      - name: Checkout Repo
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v2

      - name: Checkout Repo
        if: github.event_name == 'issue_comment'
        uses: actions/checkout@v2
        with:
          ref: refs/pull/${{ github.event.issue.number }}/merge
      - name: Get PR Number
        id: get-pr-number
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "pr_number=${{ github.event.number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for 'terraform_lock' labels on other PRs
        id: lock-check
        run: |
          LOCKED_PRS=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?state=open" | \
              jq -r "[.[] | select(.number != ${{ steps.get-pr-number.outputs.pr_number }}) | select(.labels[].name == \"terraform_lock\") | {number: .number, html_url: .html_url}] | @json")
          echo "LOCKED_PRS=$LOCKED_PRS" >> "$GITHUB_ENV"

          if [[ "$LOCKED_PRS" != "[]" ]]; then
              echo "locked=true" >> "$GITHUB_OUTPUT"
          else
              echo "locked=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment and exit if locked
        if: steps.lock-check.outputs.locked == 'true'
        uses: actions/github-script@v5
        with:
          script: |
            const lockedPrs = JSON.parse(process.env.LOCKED_PRS);
            let commentBody = 'Failed: Another pull request is currently executing:';
            lockedPrs.forEach(pr => {
            commentBody += ` [#${pr.number}](${pr.html_url})`;
            });
            commentBody += '\n\nTo continue, please execute the `terraform unlock` command in the currently executing pull request:';
            lockedPrs.forEach(pr => {
                commentBody += ` [#${pr.number}](${pr.html_url})`;
            });
            await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
            });

            process.exit(1);

      - name: Add 'terraform_lock' label to this PR
        if: steps.lock-check.outputs.locked == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.get-pr-number.outputs.pr_number }}/labels" \
            -d '{"labels": ["terraform_lock"]}'
```

ä»¥ä¸‹ã¯`terraform unlock`ã®å®Ÿè£…ã§ã™ã€‚
```yaml
jobs:
  remove-lock-label:
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.comment.body == 'terraform unlock')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Number
        id: get-pr-number
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "pr_number=${{ github.event.number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Remove 'terraform_lock' label
        run: |
          curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.get-pr-number.outputs.pr_number}}/labels/terraform_lock"

```

# GitHub Actionsã®å…¨ä½“
ä»¥ä¸Šã®è¨­è¨ˆã‚’ã¾ã¨ã‚ãŸGitHub Actionsã®å…¨ä½“ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
:::details CIã®å®šç¾©
```yaml:CI_workflow_base.yml
name: Terraform Plan base

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
    secrets:
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
      SERVICE_ACCOUNT:
        required: true

jobs:
  terraform_plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: "environments/${{inputs.project}}/"
    steps:
      - name: Checkout Repo
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v2

      - name: Checkout Repo
        if: github.event_name == 'issue_comment'
        uses: actions/checkout@v2
        with:
          ref: refs/pull/${{ github.event.issue.number }}/merge
      - name: Get PR Number
        id: get-pr-number
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "pr_number=${{ github.event.number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for 'terraform_lock' labels on other PRs
        id: lock-check
        run: |
          LOCKED_PRS=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?state=open" | \
              jq -r "[.[] | select(.number != ${{ steps.get-pr-number.outputs.pr_number }}) | select(.labels[].name == \"terraform_lock\") | {number: .number, html_url: .html_url}] | @json")
          echo "LOCKED_PRS=$LOCKED_PRS" >> "$GITHUB_ENV"

          if [[ "$LOCKED_PRS" != "[]" ]]; then
              echo "locked=true" >> "$GITHUB_OUTPUT"
          else
              echo "locked=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment and exit if locked
        if: steps.lock-check.outputs.locked == 'true'
        uses: actions/github-script@v5
        with:
          script: |
            const lockedPrs = JSON.parse(process.env.LOCKED_PRS);
            let commentBody = 'Failed: Another pull request is currently executing:';
            lockedPrs.forEach(pr => {
            commentBody += ` [#${pr.number}](${pr.html_url})`;
            });
            commentBody += '\n\nTo continue, please execute the `terraform unlock` command in the currently executing pull request:';
            lockedPrs.forEach(pr => {
                commentBody += ` [#${pr.number}](${pr.html_url})`;
            });
            await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
            });

            process.exit(1);

      - name: Add 'terraform_lock' label to this PR
        if: steps.lock-check.outputs.locked == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.get-pr-number.outputs.pr_number }}/labels" \
            -d '{"labels": ["terraform_lock"]}'

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          create_credentials_file: true
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init -no-color

      - name: Terraform Format
        run: terraform fmt -recursive -check

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        if: steps.lock-check.outputs.locked == 'false'
        run: |
          echo "plan_output_path=$(pwd)/plan_output.txt" >> "$GITHUB_OUTPUT"
          terraform plan -no-color > plan_output.txt 2>&1

      - name: Comment Plan Result on PR
        if: always() && steps.lock-check.outputs.locked == 'false'
        uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ steps.plan.outputs.plan_output_path }}', 'utf8');
            const commentBody = `
            Ran Plan for dir: \`${{inputs.project}}\`
            <details>

            <summary>Show Output</summary>

            \`\`\`
            ${planOutput}
            \`\`\`

            </details>

            To apply this plan, comment: \`terraform apply ${{inputs.project}}\`
            To plan this project again, comment: \`terraform plan ${{inputs.project}}\`
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
```
:::

:::details CDã®å®šç¾©
```yaml:CD_workflow_base.yml
name: Terraform Apply base

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
    secrets:
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
      SERVICE_ACCOUNT:
        required: true

jobs:
  terraform_apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: "environments/${{inputs.project}}/"
    steps:
      - name: Checkout Repo
        if: github.event_name == 'issue_comment'
        uses: actions/checkout@v2
        with:
          ref: refs/pull/${{ github.event.issue.number }}/merge

      - name: Get PR Number
        id: get-pr-number
        run: echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"

      - name: Check for 'terraform_lock' labels on other PRs
        id: lock-check
        run: |
          LOCKED_PRS=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?state=open" | \
              jq -r "[.[] | select(.number != ${{ steps.get-pr-number.outputs.pr_number }}) | select(.labels[].name == \"terraform_lock\") | {number: .number, html_url: .html_url}] | @json")
          echo "LOCKED_PRS=$LOCKED_PRS" >> "$GITHUB_ENV"

          if [[ "$LOCKED_PRS" != "[]" ]]; then
              echo "locked=true" >> "$GITHUB_OUTPUT"
          else
              echo "locked=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment and exit if locked
        if: steps.lock-check.outputs.locked == 'true'
        uses: actions/github-script@v5
        with:
          script: |
            const lockedPrs = JSON.parse(process.env.LOCKED_PRS);
            let commentBody = 'Failed: Another pull request is currently executing:';
            lockedPrs.forEach(pr => {
            commentBody += ` [#${pr.number}](${pr.html_url})`;
            });
            commentBody += '\n\nTo continue, please execute the `terraform unlock` command in the currently executing pull request:';
            lockedPrs.forEach(pr => {
                commentBody += ` [#${pr.number}](${pr.html_url})`;
            });
            await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
            });

            process.exit(1);

      - name: Check PR Approval Status
        id: check-pr-status
        uses: actions/github-script@v5
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
             });
            const RequestChanges = reviews.some(review => review.state === 'CHANGES_REQUESTED');
            const Approved = !RequestChanges && reviews.some(review => review.state === 'APPROVED');

            core.setOutput('approved', Approved);

      - name: Comment and exit if not approved
        if: steps.check-pr-status.outputs.approved == 'false'
        uses: actions/github-script@v5
        with:
          script: |
            await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'Failed: Pull request is not approved.'
            });

            process.exit(1);

      - name: Add 'terraform_lock' label to this PR
        if: steps.lock-check.outputs.locked == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.get-pr-number.outputs.pr_number }}/labels" \
            -d '{"labels": ["terraform_lock"]}'

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          create_credentials_file: true
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init -no-color

      - name: Terraform Apply
        id: apply
        if: steps.lock-check.outputs.locked == 'false' && steps.check-pr-status.outputs.approved == 'true'
        run: |
          echo "apply_output_path=$(pwd)/apply_output.txt" >> "$GITHUB_OUTPUT"
          terraform apply -auto-approve -no-color > apply_output.txt 2>&1

      - name: Comment Apply Result on PR
        if: always() && steps.lock-check.outputs.locked == 'false' && steps.check-pr-status.outputs.approved == 'true'
        uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs');
            const applyOutput = fs.readFileSync('${{ steps.apply.outputs.apply_output_path }}', 'utf8');
            const commentBody = `
            Ran Apply for dir: \`${{inputs.project}}\`
            <details>

            <summary>Show Output</summary>

            \`\`\`
            ${applyOutput}
            \`\`\`

            </details>
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

```
:::

:::details `terraform_lock`ãƒ©ãƒ™ãƒ«é™¤å»ã®å®šç¾©
```yaml:CI_terraform_unlock.yml
name: Terrafrom Unlock
on:
  issue_comment:
    types: [created]
  pull_request:
    branches:
      - main
    types: [closed]

jobs:
  remove-lock-label:
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.comment.body == 'terraform unlock')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Number
        id: get-pr-number
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "pr_number=${{ github.event.number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Remove 'terraform_lock' label
        run: |
          curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.get-pr-number.outputs.pr_number}}/labels/terraform_lock"
```
:::

ã¾ãŸã€ä»Šå›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯äºŒã¤ã®project(ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª)ã«å¯¾ã—ã¦Terraformã®CICDã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸãŸã‚ã€`CI_workflow_base.yml`ã¨`CD_workflow_base.yml`ã‚’ãã‚Œãã‚Œå†åˆ©ç”¨å¯èƒ½ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦å®šç¾©ã—ã€`CI_project-a-dev.yml`ã¨`CD_project-a-dev.yml`ã®ã‚ˆã†ã«ãã‚Œãã‚Œã®projectã”ã¨ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã—ã¾ã—ãŸã€‚

```yaml:CI_project-a-dev.yml
name: Terraform Plan project-a-dev

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "environments/project-a-dev/**"
  issue_comment:
    types: [created]

concurrency:
  group: project-a-dev
  cancel-in-progress: false

jobs:
  call_CI_workflow:
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.comment.body == 'terraform plan project-a-dev')
    uses: ./.github/workflows/CI_workflow_base.yml
    with:
      project: project-a-dev
    secrets:
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
```
CD_project-a-dev.yml
```yaml
name: Terraform Apply project-a-dev

on:
  issue_comment:
    types: [created]

concurrency:
  group: project-a-dev
  cancel-in-progress: false

jobs:
  call_CD_workflow:
    if: github.event_name == 'issue_comment' && github.event.comment.body == 'terraform apply project-a-dev'
    uses: ./.github/workflows/CD_workflow_base.yml
    with:
      project: project-a-dev
    secrets:
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
```
# å®Ÿéš›ã®é‹ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸
å®Ÿéš›ã«PRä¸Šã§Terraform planã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹æ§˜å­ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
![PRä¸Šã§Terraform planã‚’å®Ÿè¡Œ](/images/terraform-githubactions/pr_terraform_plan.png)

ã¾ãŸã€ã™ã§ã«Terraform PlanãŒå®Ÿè¡Œã•ã‚Œ`terraform_lock`ãƒ©ãƒ™ãƒ«ãŒã¤ã„ã¦ã„ã‚‹PRãŒå­˜åœ¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã«æ–°ã—ã„PRã§Terraform Planã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆãŒPRã«è¿½åŠ ã•ã‚Œã€Terraform PlanãŒå®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚
![ã™ã§ã«Terraform PlanãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆ](/images/terraform-githubactions/reject_terraform_plan.png)

Terraform Applyå®Ÿè¡Œæ™‚ã«PRãŒapproveã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆãŒPRã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚
![Terraform Applyå®Ÿè¡Œæ™‚ã«PRãŒapproveã•ã‚Œã¦ã„ãªã„å ´åˆ](/images/terraform-githubactions/reject_terraform_apply.png)

# ã¾ã¨ã‚
ä»¥ä¸ŠãŒGitHub Actionsã‚’ç”¨ã„ãŸAtlantis likeãªTerraformã®CICDã®æ§‹ç¯‰æ–¹æ³•ã§ã—ãŸã€‚
ä»Šå›ã®æ§‹ç¯‰ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚
- å€‹äººã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§Terraformã‚’å®Ÿè¡Œã™ã‚‹å¼·ã„æ¨©é™ã‚’ä¸ãˆã‚‹å¿…è¦ãŒãªãã€PRä¸Šã§ã®Terraformã®å®Ÿè¡Œã®ã¿ã§æ¸ˆã‚€ãŸã‚ã€ã‚¬ãƒãƒŠãƒ³ã‚¹ã‚’åŠ¹ã‹ã›ã‚‹ã“ã¨ãŒã§ãã‚‹
- PRä¸Šã®ã‚³ãƒ¡ãƒ³ãƒˆã§Terraformå®Ÿè¡ŒãŒã§ãã€ãã®çµæœã‚‚PRä¸Šã§ç¢ºèªã§ãã‚‹ãŸã‚ã€Terraformã®å®Ÿè¡Œã®å¯è¦–åŒ–ãŒã§ãã‚‹
- ãƒ­ãƒ¼ã‚«ãƒ«ã§Terraformç’°å¢ƒã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒå¿…é ˆã§ã¯ãªã„ãŸã‚ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°çµŒé¨“ã€Gitã®åˆ©ç”¨çµŒé¨“ãŒã‚ã‚Œã°ã©ãªãŸã§ã‚‚ä½œæ¥­å¯èƒ½
- PRã”ã¨ã®lockæ©Ÿèƒ½ãŒã‚ã‚‹ãŸã‚ã€è¤‡æ•°äººã§ã®Terraformã®å®Ÿè¡ŒãŒå®‰å…¨ã«ã§ãã‚‹
- GitHub Actionsã®ã¿ã§æ§‹ç¯‰ã—ãŸãŸã‚ã€ã‚³ã‚¹ãƒˆå°‘ãªãé‹ç”¨ã§ãã‚‹

å¤§è¦æ¨¡ã«é‹ç”¨ã‚’Terraformé‹ç”¨ã‚’ã—ã¦ã„ãå ´åˆã§ã¯Atlantisãªã©ã®å°‚ç”¨ã®ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ãŸæ–¹ãŒè‰¯ã„ã‹ã¨æ€ã„ã¾ã™ãŒã€å°è¦æ¨¡ãªé‹ç”¨ã§ã‚ã‚Œã°GitHub Actionsã®ã¿ã§æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ã€æœ€ä½é™ã®ã‚¬ãƒãƒŠãƒ³ã‚¹ã‚’åŠ¹ã‹ã›ã¦Terraformé‹ç”¨ã‚’å®Ÿç¾ã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
